<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>toposs/Upload</title>
    <link rel="shortcut icon" href="Icon Toposs.ico">
    <link rel="stylesheet" href="Beranda.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans&display=swap" rel="stylesheet">
</head>
<body>
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
          <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Tambahkan Poster</h2>
          </div>
          <div class="modal-body">
            <br>
            <label for="nama">Nama</label>
            <input type="text" id="nama" name="nama"><br><br>
            <label for="harga">Harga</label>
            <input type="number" id="harga" name="harga"><br><br>
            <label for="category">Category</label>
            <select id="category" name="categorylist" form="category">
                <option value="anime">Anime & Manga</option>
                <option value="cartoons">Cartoons</option>
                <option value="celeb">Celebrities</option>
                <option value="movies">Movies</option>
                <option value="sport">Sport</option>
            </select><br><br>
            <label>Image Name</label> <input type="text" id="namebox"> <label id="extLab"></label> <br><br>
            <img id="myimg"> <label id="upProgress"></label> <br><br>
            
            <button id="select">Select Image</button>
            <button id="upload">Upload Image</button>
            <button id="retrieve">Retrieve Image</button><br><br>
          </div>
        </div>
    </div>
    <div class="container">
        <!-- header -->
        <div class="flex-column">
            <nav>
                <div class="flex-row">
                    <div class="header">
                        <img class="logo" src="Logo Toposs.png" alt="Logo">
                    </div>
                    <div class="search">
                        <form class="searchbox">
                            <input class="searchtext" type="text" placeholder="Search Disini...">
                            <a href="Find.html"><span class="material-symbols-outlined searchicon">search</span></a>
                        </form>
                    </div>
                    <div class="icon">
                        <a href="Saved.html">
                            <span class="material-symbols-outlined">favorite</span><br>
                            <span>Saved</span>
                        </a>
                    </div>
                    <div class="icon">
                        <a href="Cart.html">
                            <span class="material-symbols-outlined">shopping_cart</span><br>
                            <span>Cart</span>
                        </a>
                    </div>
                    <div class="icon" id="tablogin">
                        <a href="Login.html">
                            <span class="material-symbols-outlined">person</span><br>
                            <span>Sign In</span>
                        </a>
                    </div>
                    <div class="icon" id="profile" style="display: none;">
                        <div class="dropdown">
                            <button class="dropbtn">
                                <span class="material-symbols-outlined">account_box</span>
                                <span class="material-symbols-outlined">arrow_drop_down</span>
                            </button>
                            <div class="dropdown-content">
                                <a href="Myprofile.html">My Profile</a>
                                <hr>
                                <a href="Upload.html">Upload your artwork</a>
                                <a href="Earnings.html">My Earnings</a>
                                <a href="Published.html">Upload History</a>
                                <a href="Order.html">My Orders</a>
                                <a href="Settings.html">Account Settings</a>
                                <hr>
                                <a id="logout">Log Out</a>
                            </div>
                          </div> 
                    </div>
                </div>
            </nav>

            <!-- content -->
            <div class="flex-row">
                <div class="upload-head">
                    <table class="upload-header">
                        <tr>
                            <th><h1>Drag and drop here to upload</h1></th>
                        </tr>
                        <tr>
                            <td>Add your files by dragging and dropping it here or simply click</td>
                        </tr>
                        <tr>
                            <td class="frm-box">
                                <label for="">
                                    <!-- Trigger/Open The Modal -->
                                    <button class="btn-upload" type="submit" id="myBtn">Add Artwork</button>
                                </label>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="flex-row">
                <div class="upload-before">
                    <h1>Before your upload, make sure:</h1>
                    <div id="images"></div>
                </div>
            </div>

            <div class="flex-row">
                <div class="upload-make">
                    <p>You are the owner of this artwork</p>
                    <p><span class="material-symbols-outlined">done</span>Make sure your artworks don't infringe upon the copyrights, moral rights, publicity rights, privacy rights or any other rights of another person or third party.</p>
                    <p><span class="material-symbols-outlined">close</span>We have a zero tolerance policy regarding intellectual property rights infringement.</p>
                    <p>If Toposs is made aware that an Artist has infringed the copyright or other intellectual property rights of a third party, it is Toposs policy to promptly terminate the Artist's account and remove all of the Artist's content from Toposs Website.</p>
                    <p>Put simply, stealing other people's work and passing it off as your own is againts the low and againts what Toposs stands and will stand for.</p>
                </div>
                <div class="upload-make">
                    <p>Your artwork is of high quality</p>
                    <p>DO'S:</p>
                    <p><span class="material-symbols-outlined">done</span>Upload only high-quality images in JPG format.</p>
                    <p><span class="material-symbols-outlined">done</span>The file size should be at least 2400 x 4060 px in a 1.4:1 ratio.</p>
                    <p><span class="material-symbols-outlined">done</span>Go for 3000 DPI (or more) in RGB mode.</p>
                    <p>DONT'S:</p>
                    <p><span class="material-symbols-outlined">close</span>Do not place text or content too close to the edge of the design.</p>
                    <p><span class="material-symbols-outlined">close</span>Do not add frames in the composition.</p>
                    <p><span class="material-symbols-outlined">close</span>D not manually increase the pixel dimensions of images.</p>
                    <p><span class="material-symbols-outlined">close</span>Do not add filters to try and increase the quality of images.</p>
                </div>
            </div>

            <div class="flex-row">
                <div class="footer">
                    <h3>Support</h3>
                    <p>Terms of use</p>
                    <p>Contact us</p>
                    <p>Copyrights</p>
                    <p>Privacy policy</p>
                </div>
                <div class="footer">
                    <h3>Partner</h3>
                    <img class="partner" src="img/Tokotok nama.png" alt="Logo Tokotok">
                </div>
                <div class="footer">
                    <h3>Secure payment</h3>
                    <img class="secure" src="img/payment.png" alt="Secure payment">
                </div>
                <div class="footer">
                    <h3>Find us</h3>
                    <img class="find" src="img/fb.png" alt="Facebook">
                    <img class="find" src="img/ig.png" alt="Instagram">
                    <img class="find" src="img/twit.png" alt="Twitter">
                    <img class="find" src="img/p.png" alt="Pinterest">
                </div>
            </div>    
        </div>        
    </div>
    <script src="Upload.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js";
        import { getDatabase, ref, set, push, get, child, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, uploadBytesResumable, getDownloadURL} from "https://www.gstatic.com/firebasejs/9.8.2/firebase-storage.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc} from "https://www.gstatic.com/firebasejs/9.8.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBtwsIft9BS24yfM0qAJ7VUBfE4rIXEdrM",
            authDomain: "tokoposter-59447.firebaseapp.com",
            projectId: "tokoposter-59447",
            storageBucket: "tokoposter-59447.appspot.com",
            messagingSenderId: "660302277836",
            appId: "1:660302277836:web:a607e85e507db70a682669"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage();
        const clouddb = getFirestore();
        const auth = getAuth();

        //VARIBLES
        var ImgName, ImgUrl;
        var files = [];
        var reader = new FileReader();

        var namebox = document.getElementById('namebox');
        var extlab = document.getElementById('extLab');
        var myimg = document.getElementById('myimg');
        var proglab = document.getElementById('upProgress');
        var SelBtn = document.getElementById('select');
        var UpBtn = document.getElementById('upload');
        var DownBtn = document.getElementById('retrieve');

        let nama = document.getElementById("nama");
        let harga = document.getElementById("harga");
        let category = document.getElementById("category");

        //SELECTION MODE
        var input = document.createElement('input');          
        input.type = 'file';
        input.accept = 'image/*'

        input.onchange = e => {
            files = e.target.files;
            var extention = GetFileExt(files[0]);
            var name = GetFileName(files[0]);
            reader.readAsDataURL(files[0]); 
            namebox.value = name;
            extlab.innerHTML = extention;


            reader.onload = function(){
            myimg.src = reader.result;
            } 
        }

        //Selection Menampilkan nama dan ekstensi
        SelBtn.onclick = function(){
            input.click();
        }

        function GetFileExt(file){
            var temp = file.name.split('.');
            // var bagiSpasi = file.name.split(' ')
            // console.log(bagiSpasi)
            var ext = temp.slice((temp.length-1),(temp.length));
            var done = '.'+ext[0]
            return done;
        }

        function GetFileName(file){
            var temp = file.name.split('.');
            var fname = temp.slice(0,-1).join('.');
            return fname;
        }


        //Proses Upload
        async function UploadProcess(){
            var ImgToUpload = files[0];

            var ImgName = namebox.value + extlab.innerHTML;

            const metaData = {
                contentType: ImgToUpload.type
            }

            const storageRef = sRef(storage, "Images/"+ImgName)

            const uploadTask = uploadBytesResumable(storageRef, ImgToUpload, metaData)

            uploadTask.on('state-changed', (snapshot)=>{
                var progess = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                proglab.innerHTML = "Upload "+progess+ '%';
            },

            (error) => {
                alert("error: Image not uploaded !")
            },

            ()=>{
                getDownloadURL(uploadTask.snapshot.ref).then((downloadURL)=>{
                    SaveURLtoFirestore(downloadURL)
                    alert("Success Uploaded")
                    console.log("Download URL : "+downloadURL)
                    let data = {
                        nama: nama.value,
                        kategori: category.value,
                        harga: harga.value,
                        image: downloadURL,
                    };
                    push(ref(database, "dataBarang"), data)
                    .then(() => {
                        nama.value = "";
                        category.value = "";
                        harga.value = "";
                        downloadURL="";
                        alert("Data berhasil ditambahkan");
                        document.location.reload();
                        document.location.href = "Published.html"
                    })
                    .catch((error) => {
                        console.log(error)
                        alert("Data gagal ditambahkan");
            });
                });
            }
            );

            //Function untuk Firestore Database
            async function SaveURLtoFirestore(url){
                var name = namebox.value;
                var ext = extlab.innerHTML;

                var ref = doc(clouddb, "ImageLinks/"+name);
                await setDoc(ref,{
                    ImageName: (name+ext),
                    imageURL: url
                });
            };
        };
        //Mengambil image
        async function GetImagefromFirestore(){
            var name = namebox.value;



            var ref = doc(clouddb, "ImageLinks/"+name);

            const docSnap = await getDoc(ref);

            if(docSnap.exists()){
                myimg.src = docSnap.data().imageURL;
                alert('Images success retrieved')
            }
            else{
                alert('Imaged not found')
            }
        };

        UpBtn.onclick = UploadProcess;
        DownBtn.onclick = GetImagefromFirestore;

        logout.addEventListener('click',(e)=>{

        signOut(auth).then(() => {
        // Sign-out successful.
        document.getElementById("profile").style.display="none";
        document.getElementById("tablogin").style.display="inline";
        alert('loged out');
        }).catch((error) => {
        // An error happened.
        const errorCode = error.code;
        const errorMessage = error.message;

            alert(errorMessage);
        });

        });

        const user = auth.currentUser;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("profile").style.display="inline";
                document.getElementById("tablogin").style.display="none";
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User

                const uid = user.uid;
                //bla bla bla
                // ...
            } else {
                // User is signed out
                // ...
                //bla bla bla
            }
        });
    </script>
</body>
</html>